generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



// ============================================
// Enums
// ============================================

enum Role {
  MERCHANT
  ADMIN
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  EXPIRED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// ============================================
// Core Models
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credential login
  
  role          Role      @default(MERCHANT)
  
  // 2FA Support
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Merchant Balances (Stored as Decimals for precision)
  availableBalance Decimal @default(0.0)
  pendingBalance   Decimal @default(0.0)
  totalIncome      Decimal @default(0.0)
  
  // Webhook Integration
  webhookUrl       String?
  webhookSecret    String?   @default(cuid()) // Secret for signing IPNs sent to the merchant

  // Relations
  accounts      Account[]
  sessions      Session[]
  apiKeys       ApiKey[]
  transactions  Transaction[]
  invoices      Invoice[]
  withdrawals   Withdrawal[]
  loginHistory  LoginHistory[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model LoginHistory {
  id          String   @id @default(cuid())
  userId      String
  ipAddress   String?  // The IP Address used for login
  userAgent   String?  // The browser/device info
  location    String?  // Optional parsed location
  status      String   @default("SUCCESS") // SUCCESS, FAILED_PASSWORD, FAILED_2FA
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
}

model ApiKey {
  id             String   @id @default(cuid())
  key            String   @unique 
  prefix         String   // Visible part, e.g., pk_live_a1b2...
  name           String   @default("Default API Key")
  walletAddress  String?  // Receiving wallet address for this API key
  active         Boolean  @default(true)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id                 String   @id @default(cuid())
  platformTxId       String   @unique @default(cuid()) // Our Master TxID generated for the merchant
  providerTxId       String?  // Underlying provider's TxID (from NowPayments, added via webhook)

  amount             Decimal  // For sqlite compat without scaling
  currency           String   // e.g., USDT, BTC
  
  feePlatform        Decimal  @default(0.0) // 3% fee charged to the merchant
  feeProvider        Decimal  @default(0.0) // 0.5% fee charged by the provider
  profitPlatform     Decimal  @default(0.0) // 2.5% platform margin
  amountMerchant     Decimal  @default(0.0) // amount added to merchant balance: amount - feePlatform
  payAddress         String?  // Crypto deposit address generated by provider for customer to pay
  payAmount          Decimal? // The precise crypto amount to be paid
  payCurrency        String?  // The specific crypto currency selected
  
  status             TransactionStatus @default(PENDING)
  customerEmail      String?  // Optional customer details

  invoiceId          String?  @unique
  invoice            Invoice? @relation(fields: [invoiceId], references: [id])

  userId             String
  merchant           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Withdrawal {
  id        String   @id @default(cuid())
  
  amount    Decimal
  currency  String
  address   String   // Destination Crypto address for the merchant's payout
  
  status    WithdrawalStatus @default(PENDING)
  txHash    String?  // Blockchain transaction hash when payout completes
  
  userId    String
  merchant  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id               String   @id @default(cuid())
  amount           Decimal  // Requested fiat or crypto amount
  currency         String   @default("USD") // E.g., USD
  orderId          String?  // Merchant's internal order ID
  orderDescription String?
  
  status           String   @default("PENDING") // PENDING, COMPLETED, EXPIRED
  
  userId           String
  merchant         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  transaction      Transaction? // Link to the specific crypto payment transaction once selected

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ============================================
// NextAuth Required Models
// ============================================

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
